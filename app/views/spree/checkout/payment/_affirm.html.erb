<div class="affirm-checkout-button" data-product-key="<%= payment_method.preferred_product_key %>"></div>

<script>
(function(){
  /* only include this setup once */
  if (!window.AffirmPaymentMethods) {

    /*****************************************************\
        Include the affirm js snippet
    \*****************************************************/
    var _affirm_config = {
      public_api_key: "<%= payment_method.preferred_api_key %>",
      script: "https://<%= payment_method.preferred_server %>/js/v2/affirm.js"
    };
    (function(l,g,m,e,a,f,b){var d,c=l[m]||{},h=document.createElement(f),n=document.getElementsByTagName(f)[0],k=function(a,b,c){return function(){a[b]._.push([c,arguments])}};c[e]=k(c,e,"set");d=c[e];c[a]={};c[a]._=[];d._=[];c[a][b]=k(c,a,b);a=0;for(b="set add save post open empty reset on off trigger ready setProduct".split(" ");a<b.length;a++)d[b[a]]=k(c,e,b[a]);a=0;for(b=["get","token","url","items"];a<b.length;a++)d[b[a]]=function(){};h.async=!0;h.src=g[f];n.parentNode.insertBefore(h,n);delete g[f];d(g);l[m]=c})(window,_affirm_config,"affirm","checkout","ui","script","ready");


    /*****************************************************\
        handle continue button clicks with .open()
    \*****************************************************/
    window.AffirmPaymentMethods = {};

    $(function() {
      $('.continue').click(function(e){
        var checkedPaymentMethod = $('div[data-hook="checkout_payment_step"] input[type="radio"]:checked').val();

        if (window.AffirmPaymentMethods[checkedPaymentMethod]) {
          affirm.checkout(window.AffirmPaymentMethods[checkedPaymentMethod]);
          affirm.checkout.open();

          e.preventDefault();
          return false;
        }
      });
    });

    /*****************************************************\
        set the shared checkout data
    \*****************************************************/
    affirm.checkout({
      currency:             "USD",
      tax_amount:           <%= @order.additional_tax_total * 100 %>,
      checkout_id:          "<%= @order.number %>",
      discount_code:        "<%= @order.coupon_code %>",
      shipping_type:        "<%= @order.shipments.first.shipping_method.name if @order.shipments %>",
      shipping_amount:      <%= @order.shipment_total * 100 %>,
      misc_fee_amount:      <%= (@order.adjustment_total - @order.additional_tax_total) * 100 %>,

      shipping: {
        name: {
          full:  "<%= @order.ship_address.full_name %>",
        },
        address: {
          line1:        "<%= @order.ship_address.address1 %>",
          line2:        "<%= @order.ship_address.address2 %>",
          city:         "<%= @order.ship_address.city %>",
          state:        "<%= @order.ship_address.state_text %>",
          country:      "<%= @order.ship_address.country.iso %>",
          zipcode:      "<%= @order.ship_address.zipcode %>",
        }
      },

      billing: {
        email: "<%= @order.email %>",
        name: {
          full:   "<%= @order.bill_address.full_name %>"
        },
        address: {
          line1:          "<%= @order.bill_address.address1 %>",
          line2:          "<%= @order.bill_address.address2 %>",
          city:           "<%= @order.bill_address.city %>",
          state:          "<%= @order.bill_address.state_text %>",
          country:        "<%= @order.bill_address.country.iso %>",
          zipcode:        "<%= @order.bill_address.zipcode %>",
        }
      },

      merchant: {
        user_confirmation_url:    "<%= confirm_affirm_url(:payment_method_id => payment_method.id) %>",
        user_cancel_url:          "<%= cancel_affirm_url(:payment_method_id => payment_method.id) %>",
      },

      config: {
        required_billing_fields:      "name,address,email",
      },

      items: [
        <% @order.line_items.each do |item| %>
        {
          <% if item.variant.images.any? %>
            item_image_url: "<%= URI.join(root_url, item.variant.images.first.attachment.url(:large)) %>",
          <% end %>

          qty:           <%= item.quantity %>,
          sku:           "<%= item.variant.sku %>",
          item_url:      "<%= product_url(item.product) %>",
          unit_price:    <%= item.price * 100 %>,
          display_name:  "<%= raw(item.variant.product.name) %>"
        },
        <% end %>
      ]
    });
  }


  /*****************************************************\
      set the product/button specific data to be
      used when the continue button is directly
      clicked
  \*****************************************************/
  window.AffirmPaymentMethods["<%= payment_method.id %>"] = {
    public_api_key:           "<%= payment_method.preferred_api_key %>",
    financial_product_key:        "<%= payment_method.preferred_product_key %>"
  };

}());
</script>
